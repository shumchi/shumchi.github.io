<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>卫生政策与管理实证研究手册 - 7&nbsp; 番外篇（二）：匹配</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./chapter_8.html" rel="next">
<link href="./chapter_6.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">番外篇（二）：匹配</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">卫生政策与管理实证研究手册</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">前言</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">文献知识的获取与管理</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">数据库操作</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_3.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">数据的清洗</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_4.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">数据的描述</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_5.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">因果推断方法</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_6.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">番外篇（一）：随机化分组</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_7.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">番外篇（二）：匹配</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_8.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">番外篇（三）：主成分分析</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_references.html" class="sidebar-item-text sidebar-link">参考文献</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#引子" id="toc-引子" class="nav-link active" data-scroll-target="#引子"><span class="toc-section-number">7.1</span>  引子</a></li>
  <li><a href="#背景介绍" id="toc-背景介绍" class="nav-link" data-scroll-target="#背景介绍"><span class="toc-section-number">7.2</span>  背景介绍</a></li>
  <li><a href="#psm与cem" id="toc-psm与cem" class="nav-link" data-scroll-target="#psm与cem"><span class="toc-section-number">7.3</span>  PSM与CEM</a></li>
  <li><a href="#算法" id="toc-算法" class="nav-link" data-scroll-target="#算法"><span class="toc-section-number">7.4</span>  ## 算法</a></li>
  <li><a href="#不平衡度测量" id="toc-不平衡度测量" class="nav-link" data-scroll-target="#不平衡度测量"><span class="toc-section-number">7.5</span>  ## 4. 不平衡度测量</a></li>
  <li><a href="#匹配" id="toc-匹配" class="nav-link" data-scroll-target="#匹配"><span class="toc-section-number">7.6</span>  ## 5. 匹配</a>
  <ul class="collapse">
  <li><a href="#示例的dataset介绍" id="toc-示例的dataset介绍" class="nav-link" data-scroll-target="#示例的dataset介绍"><span class="toc-section-number">7.6.1</span>  5.1 示例的dataset介绍</a></li>
  <li><a href="#匹配前准备不平衡度测量" id="toc-匹配前准备不平衡度测量" class="nav-link" data-scroll-target="#匹配前准备不平衡度测量"><span class="toc-section-number">7.6.2</span>  5.1 匹配前准备：不平衡度测量</a></li>
  <li><a href="#开始匹配" id="toc-开始匹配" class="nav-link" data-scroll-target="#开始匹配"><span class="toc-section-number">7.6.3</span>  5.2 开始匹配</a></li>
  <li><a href="#匹配后处理" id="toc-匹配后处理" class="nav-link" data-scroll-target="#匹配后处理"><span class="toc-section-number">7.6.4</span>  5.3 匹配后处理</a></li>
  <li><a href="#自行设定粗化的cutpoint" id="toc-自行设定粗化的cutpoint" class="nav-link" data-scroll-target="#自行设定粗化的cutpoint"><span class="toc-section-number">7.6.5</span>  5.4 自行设定粗化的cutpoint</a></li>
  <li><a href="#权重weights的应用" id="toc-权重weights的应用" class="nav-link" data-scroll-target="#权重weights的应用"><span class="toc-section-number">7.6.6</span>  5.5 权重weights的应用</a></li>
  <li><a href="#k2k进行11匹配" id="toc-k2k进行11匹配" class="nav-link" data-scroll-target="#k2k进行11匹配"><span class="toc-section-number">7.6.7</span>  5.6 k2k进行1:1匹配</a></li>
  </ul></li>
  <li><a href="#参考文献" id="toc-参考文献" class="nav-link" data-scroll-target="#参考文献"><span class="toc-section-number">7.7</span>  ## 6. 参考文献</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">番外篇（二）：匹配</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="引子" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="引子"><span class="header-section-number">7.1</span> 引子</h2>
<blockquote class="blockquote">
<p>“The goal of matching is to reduce imbalance in the empirical distribution of the pre-treatment confounders between the treated and control groups.”</p>
</blockquote>
<blockquote class="blockquote">
<p align="right">
—– Stuart, Elizabeth A. (2010)
</p>
</blockquote>
</section>
<section id="背景介绍" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="背景介绍"><span class="header-section-number">7.2</span> 背景介绍</h2>
<p>Coarsened Exact Matching (CEM) 方法由University of Milan的Stefano M. Iacus，Harvard University的Gary King， 以及University of Trieste的Giuseppe Porro提出，其算法最早于2008年在线发表在Gary King的Harvard University主页上 <a href="http://gking.harvard.edu/files/abs/cem-abs.shtml">“Matching for Causal Inference Without Balance Checking.”</a>。</p>
<p>其后分别在 <strong>Journal of Statistical Software (2009)</strong> 和 <strong>The Stata Journal (2009)</strong> 上发表了R和Stata版本的相关package， 其正式成果于2011年发表于 <strong>Journal of the American Statistical Association</strong> 上，以及2012的<a href="http://j.mp/2nRpUHQ">Political Analysis</a>上。</p>
<p>CEM亦可称之为“Cochran Exact Matching” ，衍生于Cochran于1986年提出的<strong>subclassification-based method （Cochran, W. G., 1968)</strong>，在2011年发表的论文中Gary King等人亦将CEM与PSM (Propensity Score Matching)进行了比较，提出了CEM的优势。</p>
<p><br></p>
</section>
<section id="psm与cem" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="psm与cem"><span class="header-section-number">7.3</span> PSM与CEM</h2>
<p>在CEM方法提出之前，已有较多的匹配方法，其中最具有代表性的就是 <strong>Paul R. Rosenbaum and Rubin (1983)</strong> 提出的Propensity score matching (PSM)， 截至目前，使用PSM发表的论文已超过10000篇，是目前最常用的匹配方法。从下图中也能看出两种方法在发表论文中使用的差距。Gary King在一篇Working paper (“Why Propensity Scores Should Not Be Used for Matching”)中指出了PSM的不足，原文如下：</p>
<blockquote class="blockquote">
<p>We show here that PSM, as it is most commonly used in practice (or with many of the refinements that have been proposed by statisticians and methodologists), increases imbalance, inefficiency, model dependence, research discretion, and statistical bias at some point in both real data and in data generated to meet the requirements of PSM theory. <font color="#00dd00">In fact, the more balanced the data, or the more balanced it becomes by pruning some observations through matching, the more likely PSM will degrade inferences — a problem we refer to as the PSM paradox</font>. If one’s data are so imbalanced that making valid causal inferences from it without heavy modeling assumptions is impossible, then the paradox we identify is avoidable and PSM will reduce imbalance but then the data are not very useful for causal inference by any method.</p>
</blockquote>
<p>也许只有名字里带King的人论文题目敢这么写，当然，不出你所料，自然也会有这样一篇文章“Why propensity scores should be used for matching” <strong>(Ben Jann, 2017).</strong> ,至于CEM与PSM孰优孰劣，只能依据个人研究自行判断了。</p>
<p><img src="figures/Number-of-article-1.png" class="img-fluid"></p>
<p><img src="figures/Number-of-article-2.png" class="img-fluid"></p>
</section>
<section id="算法" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="算法"><span class="header-section-number">7.4</span> ## 算法</h2>
<p>CEM没有PSM那么复杂的反事实假设，其算法一共可分为三步：</p>
<ul>
<li>将所有纳入匹配的协变量，粗化（coarsen）成离散分组，对于已是分类变量的协变量，可以自行设定（比如，性别、教育程度等），而对于连续型变量 CEM算法会根据自动频率分布直方图进行自动粗化，当然也可以自行手动设定cutpoint,s, 并且可以设定自动粗化的方法(Sturges’ rule, the default), “fd” (Freedman-Diaconis’ rule), “scott” (Scott’s rule) and “ss” (ShimazakiShinomoto’s rule)。</li>
<li>对所有粗化之后的分类进行分层并排序</li>
<li>删除未同时包含至少一个Treat组和Control组的层</li>
</ul>
<p><br></p>
</section>
<section id="不平衡度测量" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="不平衡度测量"><span class="header-section-number">7.5</span> ## 4. 不平衡度测量</h2>
<p>CEM中引入了一个参数L1来衡量Treat组和Control组之间在协变量上的不平衡度，其计算公式如下：</p>
<blockquote class="blockquote">
<p><em>L</em><sub>1</sub>(<em>f</em>, <em>g</em>) = ∑|<em>f</em><sub><em>e</em></sub>(1…<em>k</em>)−<em>g</em><sub><em>e</em></sub>(1…<em>k</em>)|</p>
</blockquote>
<p>L1取值在0~1之间，0代表完全平衡，1代表完全不平衡。若L1为0.6，即说明有40%的粗化后各层的频率分布 直方图在Treat组和Control组之间是重叠的，L1即是根据各层的相对频率差值求和而得，示例如下：</p>
<p>假设有三个协变量（X1…X），粗化后个协变量的分类为（2, 3, 5），那么粗化后共有2<em>3</em>5=30个层， 我们随机为Treat组和Control组在360个层生成一个正整数，最后计算频率并画出直方图。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seed</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2019</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Data</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>strate <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">paste</span>(<span class="st">"str"</span>, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>), <span class="at">sep =</span> <span class="st">"_"</span>), <span class="at">size =</span> <span class="dv">2000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>group <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Treat"</span>, <span class="st">"Control"</span>), <span class="dv">1000</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>imb <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">strate =</span> strate, <span class="at">group =</span> group)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>imb_sum <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(<span class="fu">table</span>(imb<span class="sc">$</span>group, imb<span class="sc">$</span>strate), <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(imb_sum) <span class="sc">+</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">x =</span> Var2, <span class="at">y =</span> Freq, <span class="at">fill =</span> Var1), <span class="at">position =</span> <span class="st">"dodge"</span>, <span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>     <span class="fu">scale_fill_manual</span>(<span class="at">name =</span> <span class="st">""</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>     <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Prop"</span>, <span class="at">x =</span> <span class="st">"Strates"</span>) <span class="sc">+</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>     <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="https://github.com/shumchi/shumchi.github.io/blob/master/_posts/2019-04-14-How-to-do-a-Coarsened-Exact-Matching/figure-markdown_strict/imbalance-1.png?raw=true" class="img-fluid"></p>
<p><br></p>
</section>
<section id="匹配" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="匹配"><span class="header-section-number">7.6</span> ## 5. 匹配</h2>
<p><strong>采用R语言中的cem包，示例的dataset为cem包中自带的LeLonde</strong></p>
<section id="示例的dataset介绍" class="level3" data-number="7.6.1">
<h3 data-number="7.6.1" class="anchored" data-anchor-id="示例的dataset介绍"><span class="header-section-number">7.6.1</span> 5.1 示例的dataset介绍</h3>
<p><strong>Outcome variable:</strong> re78<br>
<strong>Treat variable:</strong> treated, 1 = treat group, 0 = control group<br>
<strong>Control variable:</strong> c(“age”, “education”, “black”, “married”, “nodegree”, “re74”, “re75”, “hispanic”, “u74”, “u75”,“q1”)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cem)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(LeLonde)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> LeLonde[<span class="fu">c</span>(<span class="st">"treated"</span>, <span class="st">"re78"</span>, <span class="st">"age"</span>, </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                <span class="st">"education"</span>, <span class="st">"black"</span>, <span class="st">"married"</span>, </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">"nodegree"</span>, <span class="st">"re74"</span>, <span class="st">"re75"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                <span class="st">"hispanic"</span>, <span class="st">"u74"</span>, <span class="st">"u75"</span>, <span class="st">"q1"</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">na.omit</span>()</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="匹配前准备不平衡度测量" class="level3" data-number="7.6.2">
<h3 data-number="7.6.2" class="anchored" data-anchor-id="匹配前准备不平衡度测量"><span class="header-section-number">7.6.2</span> 5.1 匹配前准备：不平衡度测量</h3>
<p>利用 <em>imbalance()</em> 函数对匹配的数据的不平衡进行测量，如下结果所示，整体不平衡度为0.902， 意味数据存在较高的不平衡性。</p>
<p>对于连续型变量，默认计算mean in difference，对于分类变量默认计算chi square。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">imbalance</span>(<span class="at">group =</span> df<span class="sc">$</span>treated, <span class="at">data =</span> df[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="开始匹配" class="level3" data-number="7.6.3">
<h3 data-number="7.6.3" class="anchored" data-anchor-id="开始匹配"><span class="header-section-number">7.6.3</span> 5.2 开始匹配</h3>
<p>利用 <em>cem()</em> 函数进行CEM匹配，参数treatment用来指定分组变量，drop用来排除结局变量。</p>
<p>从结果可以看出，Control组从全部392个样本中匹配上95例，Treat组从全部258个样本中匹配上84例，匹配后样本的整体 L1为0.605，相比匹配前，有所下降。另外，从statistic列的结果也可看出，在各匹配变量中两组之间无统计学差异。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">cem</span>(<span class="at">treatment =</span> <span class="st">"treated"</span>, <span class="at">data =</span> df, <span class="at">drop =</span> <span class="st">"re78"</span>, <span class="at">eval.imbalance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>mat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>然而</strong>，此处我产生一个小疑惑，纳入匹配变量的数据类型是否会影响粗化分组过程，从而影响匹配结局？</p>
<p><strong>因此</strong>，我将black、married等分类变量设置成factor类型，比较前后不平衡度测量及匹配结果。</p>
<p><strong>区别</strong>，比较结果看出，与前述结果并无差异，仅在测量不平衡度时对于分类变量采用了chi square.<br>
<font color="#FF0000">另一个明显的区别在于，对于设置成分类变量后，在进行匹配时，不会再对分类变量进行粗化。</font></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df_1 <span class="ot">&lt;-</span> df</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df_1<span class="sc">$</span>black <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df_1<span class="sc">$</span>black)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>df_1<span class="sc">$</span>married <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df_1<span class="sc">$</span>married)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>df_1<span class="sc">$</span>nodegree <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df_1<span class="sc">$</span>nodegree)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">imbalance</span>(<span class="at">group =</span> df<span class="sc">$</span>treated, <span class="at">data =</span> df_1[, <span class="sc">-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)])</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cem</span>(<span class="at">treatment =</span> <span class="st">"treated"</span>, <span class="at">data =</span> df_1, <span class="at">drop =</span> <span class="st">"re78"</span>, <span class="at">eval.imbalance =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="匹配后处理" class="level3" data-number="7.6.4">
<h3 data-number="7.6.4" class="anchored" data-anchor-id="匹配后处理"><span class="header-section-number">7.6.4</span> 5.3 匹配后处理</h3>
<p>匹配后生成的匹配对象（mat），其类为 cem.match，其属性实为 list。</p>
<section id="mat的数据结构如下" class="level4" data-number="7.6.4.1">
<h4 data-number="7.6.4.1" class="anchored" data-anchor-id="mat的数据结构如下"><span class="header-section-number">7.6.4.1</span> mat的数据结构如下:</h4>
<p>其中详细记录了匹配结果与参数，需要关注的有breaks，matched，w三个对象中的信息。</p>
<ul>
<li>breaks为一个list，其中记录匹配变量自动粗化过程中设置的cutpoint（仅包含numeric类型）<br>
</li>
<li>matched实为一个逻辑向量，记录了该个体是否进入了匹配后的样本<br>
</li>
<li>w为匹配权重（详细见5.5），用于后续的统计分析中</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(mat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="提取匹配后的样本" class="level4" data-number="7.6.4.2">
<h4 data-number="7.6.4.2" class="anchored" data-anchor-id="提取匹配后的样本"><span class="header-section-number">7.6.4.2</span> 提取匹配后的样本:</h4>
<p><strong>CEM</strong>包中给出了不用单独提取出匹配后样本进行回归的函数 <em>att()</em>, 不过我个人比较倾向将匹配后的样本单独存储为一个对象， 但是 <strong>CEM</strong>包中并未给出像 <strong>MatchIt</strong>中的 <em>match.out()</em>函数，至少我还没有找到，所以只能自己动手，丰衣足食</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 提取匹配结果</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>mat<span class="sc">$</span>matched</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 提取匹配后的样本</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>df_matched <span class="ot">&lt;-</span> <span class="fu">cbind</span>(df, mat<span class="sc">$</span>w, mat<span class="sc">$</span>matched)[<span class="fu">which</span>(mat<span class="sc">$</span>matched),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="自行设定粗化的cutpoint" class="level3" data-number="7.6.5">
<h3 data-number="7.6.5" class="anchored" data-anchor-id="自行设定粗化的cutpoint"><span class="header-section-number">7.6.5</span> 5.4 自行设定粗化的cutpoint</h3>
<p>对于连续型变量或者类别较多的分类变量，可以通过 <em>cem()函数</em> 中cutpoints和grouping两个参数来设定粗化的分割点，以下以cutpoints为例;</p>
<p>从上述匹配后的结果中可以看出age变量的自动cutpoint为 17, 20.8, 24.6, 28.4, 32.2, 36, 39.8, 43.6, 47.4, 51.2, 55</p>
<p><font color="#836FFF"> 如果是采用算法自动设定cutpoint， 可以通过 <em>cem()函数</em> 中L1.breaks = “fd”等（见3. 算法）来选择不同的方法。</font></p>
<ul>
<li><p>如果自行设定，需要通过cutpoints = list(education = c(0, 6.5, 8.5, 12.5, 17))来设定，即通过list形式为需要的匹配变量 赋值一个数值向量。</p></li>
<li><p>grouping参数赋值同理，list(c(“strongly agree”, “agree”), c(“neutral”,“no opinion”), c(“strongly))，不过我个人比较习惯提前使用factor() 设定好分类。</p></li>
</ul>
</section>
<section id="权重weights的应用" class="level3" data-number="7.6.6">
<h3 data-number="7.6.6" class="anchored" data-anchor-id="权重weights的应用"><span class="header-section-number">7.6.6</span> 5.5 权重weights的应用</h3>
<p>由于CEM为不对称匹配，当一个Treat样本匹配多个Control样本时，需要通过权重来更准确的估计平均处理效应(ATT)，Gary King的原话如下：</p>
<blockquote class="blockquote">
<p>They enable us to use a calculation trick that makes it easy to estimate the ATT in a weighted least squares regression program without the involved procedure.</p>
</blockquote>
<p><strong>关于权重需要注意的三点：</strong></p>
<ul>
<li>当匹配为不对称时，对匹配后的样本进行的所有的统计分析，都应对权重进行加权，在PSM中进行一对多匹配时同理</li>
<li>CEM中权重的理解十分简单，未匹配上的个案权重全为0， 匹配上的Treat组个案权重都为1， 匹配上的Control组个案的权重是对粗化后各层内 Treat和Control组的样本比与全部样本中Treat和Control组的样本比相乘而来((m_C/m_T)*Ws)</li>
<li>匹配后样本的权重之和就等于匹配后样本量的大小，如本例中sum of weigths = sample of matched = 179</li>
</ul>
<p>关于权重的具体计算方法，详见<a href="https://docs.google.com/document/d/1xQwyLt_6EXdNpA685LjmhjO20y5pZDZYwe2qeNoI5dE/edit">An Explanation for CEM Weights</a> （需要科学上网）</p>
</section>
<section id="k2k进行11匹配" class="level3" data-number="7.6.7">
<h3 data-number="7.6.7" class="anchored" data-anchor-id="k2k进行11匹配"><span class="header-section-number">7.6.7</span> 5.6 k2k进行1:1匹配</h3>
<p>虽然CEM的优势在于可以进行非对称匹配，从而保留更多的样本，但是当样本量比较充足时，为了保证更准确的估计ATT，可以 进行1:1匹配，<strong>cem() 包</strong> 也给出了对应的函数 <em>k2k()</em> ，示列如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 用单独的k2k函数时，之前生成cem对象mat时，必须加上keep.all = TRUE参数</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># mat2 &lt;- k2k(obj = mat, data = df, method = "euclidean", mpower = 1)</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 或</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>mat2 <span class="ot">&lt;-</span> <span class="fu">cem</span>(<span class="at">treatment =</span> <span class="st">"treated"</span>, <span class="at">data =</span> df_1, <span class="at">drop =</span> <span class="st">"re78"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">eval.imbalance =</span> <span class="cn">TRUE</span>, <span class="at">k2k =</span> <span class="cn">TRUE</span>, <span class="at">method =</span> <span class="st">"euclidean"</span>, <span class="at">mpower =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>进行1:1匹配时，实际采用最近距离法在各层内选取，判断距离的方法可选（‘euclidean’, ‘maximum’, ‘manhattan’, ‘canberra’, ‘binary’ and ‘minkowski’)，默认为NULL，即随机选取。</p>
<p><font color="#FF0000"> 需要注意的一点是，使用k2k进行1:1匹配后，后续统计分析时就无需进行权重加权了。</font></p>
</section>
</section>
<section id="参考文献" class="level2" data-number="7.7">
<h2 data-number="7.7" class="anchored" data-anchor-id="参考文献"><span class="header-section-number">7.7</span> ## 6. 参考文献</h2>
<ul>
<li>Stuart, Elizabeth A. (2010): “Matching Methods for Causal Inference: A Review and a Look Forward”. In: Statistical Science, no. 1, vol. 25, pp.&nbsp;1–21.</li>
<li>Iacus SM, King G, Porro G (2008). “Matching for Causal Inference Without Balance Checking.” Submitted, URL <a href="http://gking.harvard.edu/files/abs/cem-abs.shtml" class="uri">http://gking.harvard.edu/files/abs/cem-abs.shtml</a>.</li>
<li>Stefano M Iacus, Gary King, and Giuseppe Porro. 2009. “CEM: Software for Coarsened Exact Matching.” Journal of Statistical Software, 30.</li>
<li>Matthew Blackwell, Stefano Iacus, Gary King, and Giuseppe Porro. 2009. “CEM: Coarsened Exact Matching in Stata.” The Stata Journal, 9, Pp. 524–546.</li>
<li>Stefano M Iacus, Gary King, and Giuseppe Porro. 2011. “Multivariate Matching Methods That are Monotonic Imbalance Bounding.” Journal of the American Statistical Association, 106, 493, Pp. 345-361.</li>
<li>Stefano M. Iacus, Gary King, and Giuseppe Porro. 2012. “Causal Inference Without Balance Checking: Coarsened Exact Matching.” Political Analysis, 20, 1, Pp. 1–24. Website Copy at <a href="http://j.mp/2nRpUHQ" class="uri">http://j.mp/2nRpUHQ</a></li>
<li>Rosenbaum, Paul R. and Donald B. Rubin (1983): “The Central Role of the Propensity Score in Observational Studies for Causal Effects”. In: Biometrika, vol.&nbsp;70, pp.&nbsp;41–55.</li>
<li>Cochran, W. G. (1968), “The Effectiveness of Adjustment by Subclassification in Removing Bias in Observational Studies,” Biometrics, 24, 295–313 [350].</li>
<li>Why propensity scores should be used for matching,” German Stata Users’ Group Meetings 2017 01, Stata Users Group.</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./chapter_6.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">番外篇（一）：随机化分组</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./chapter_8.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">番外篇（三）：主成分分析</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">
        <ul class="footer-items list-unstyled">
    <li class="nav-item">
 © 2023 Chi Shen, Xi'an Jiaotong University
  </li>  
</ul>
      </div>
  </div>
</footer>



</body></html>