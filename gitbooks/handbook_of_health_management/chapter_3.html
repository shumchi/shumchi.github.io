<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>卫生政策实证研究手册 - 3&nbsp; 数据的清洗</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./chapter_4.html" rel="next">
<link href="./chapter_2.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">数据的清洗</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">卫生政策实证研究手册</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">前言</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">文献知识的获取与管理</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">数据库操作</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_3.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">数据的清洗</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_4.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">数据的描述</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_5.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">因果推断方法</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_6.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">番外篇</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">参考文献</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#引子" id="toc-引子" class="nav-link active" data-scroll-target="#引子"><span class="toc-section-number">3.1</span>  引子</a></li>
  <li><a href="#数据清洗相关概念" id="toc-数据清洗相关概念" class="nav-link" data-scroll-target="#数据清洗相关概念"><span class="toc-section-number">3.2</span>  数据清洗相关概念</a>
  <ul class="collapse">
  <li><a href="#数据清洗data-cleaning" id="toc-数据清洗data-cleaning" class="nav-link" data-scroll-target="#数据清洗data-cleaning"><span class="toc-section-number">3.2.1</span>  数据清洗（Data Cleaning）</a></li>
  <li><a href="#sec-tidy" id="toc-sec-tidy" class="nav-link" data-scroll-target="#sec-tidy"><span class="toc-section-number">3.2.2</span>  整洁数据（Tidy Data）</a></li>
  </ul></li>
  <li><a href="#数据清洗内容" id="toc-数据清洗内容" class="nav-link" data-scroll-target="#数据清洗内容"><span class="toc-section-number">3.3</span>  数据清洗内容</a>
  <ul class="collapse">
  <li><a href="#数据清洗的第一步" id="toc-数据清洗的第一步" class="nav-link" data-scroll-target="#数据清洗的第一步"><span class="toc-section-number">3.3.1</span>  数据清洗的第一步</a></li>
  <li><a href="#规范变量类型及取值" id="toc-规范变量类型及取值" class="nav-link" data-scroll-target="#规范变量类型及取值"><span class="toc-section-number">3.3.2</span>  规范变量类型及取值</a></li>
  <li><a href="#异常值outliers处理" id="toc-异常值outliers处理" class="nav-link" data-scroll-target="#异常值outliers处理"><span class="toc-section-number">3.3.3</span>  异常值（Outliers）处理</a></li>
  </ul></li>
  <li><a href="#缺失值missing-value处理" id="toc-缺失值missing-value处理" class="nav-link" data-scroll-target="#缺失值missing-value处理"><span class="toc-section-number">3.4</span>  缺失值（Missing Value）处理</a>
  <ul class="collapse">
  <li><a href="#识别缺失数据" id="toc-识别缺失数据" class="nav-link" data-scroll-target="#识别缺失数据"><span class="toc-section-number">3.4.1</span>  识别缺失数据</a></li>
  <li><a href="#探索缺失原因或模式" id="toc-探索缺失原因或模式" class="nav-link" data-scroll-target="#探索缺失原因或模式"><span class="toc-section-number">3.4.2</span>  探索缺失原因或模式</a></li>
  <li><a href="#缺失值的处理" id="toc-缺失值的处理" class="nav-link" data-scroll-target="#缺失值的处理"><span class="toc-section-number">3.4.3</span>  缺失值的处理</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">数据的清洗</span></h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<section id="引子" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="引子"><span class="header-section-number">3.1</span> 引子</h2>
<p>  正如前文所述，数据清洗（Data Cleaning）和数据准备（Data Preparation）工作通常会占掉整个数据分析过程70%到80%的时间，这一点基本被很多学者所认可，因此，应该清楚地认识到数据清洗工作的重要性。然而，很多学者，特别是还处在科研早期阶段的硕博士研究生，十分热衷于跑模型（Run model）。拿到数据既不详细摸索数据结构，也不观察变量分布情况，简单地描述一下数据后，就开始跑各种回归，目的只在发现统计显著的回归系数。这是一个不太好的研究习惯。</p>
</section>
<section id="数据清洗相关概念" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="数据清洗相关概念"><span class="header-section-number">3.2</span> 数据清洗相关概念</h2>
<section id="数据清洗data-cleaning" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="数据清洗data-cleaning"><span class="header-section-number">3.2.1</span> 数据清洗（Data Cleaning）</h3>
<p>  何谓数据清洗？目前其实没有统一的定义，但是在不同的学科领域中，数据清洗的目标和内容基本是明确一致的，那就是识别、修改或删除不正确和不完整的数据，识别和删除重复信息和无关数据，以及按一定的标准统一数据格式、缺失值和拼写错误，规范数据结构，从而更好地为下一步分析工作服务。结合<a href="https://support.microsoft.com/en-us/office/top-ten-ways-to-clean-your-data-2844b620-677c-47a7-ac3e-c2e157d1db19">Microsoft</a>、<a href="https://aws.amazon.com/cn/what-is/data-cleansing/">Amazon</a>以及 <span class="citation" data-cites="cody2008">(<a href="references.html#ref-cody2008" role="doc-biblioref">Ron 2008</a>)</span> 的观点，本书将常见的数据清洗步骤归纳如下：</p>
<ol type="1">
<li>识别并处理异常值：异常值会对数据分布产生明显影响，干扰正常结果，并显著影响模型性能，通常进行删除。</li>
<li>识别并处理缺失数据：缺失值是无法避免的问题，但需要掌握数据中的缺失特征并予以处理。</li>
<li>识别并处理重复数据：删除重复信息。</li>
<li>规范变量类型及取值：根据变量的属性特征，正确将其存储为数值、字符、日期、时间等类型，并统一取值类型。</li>
<li>识别并处理不相关数据：确定特定分析的关键字段并从分析中删除不相关数据。</li>
<li>识别并处理结构错误：识别数据库在录入和建立过程中出现的错误，如输入错误、错行等。</li>
</ol>
</section>
<section id="sec-tidy" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="sec-tidy"><span class="header-section-number">3.2.2</span> 整洁数据（Tidy Data）</h3>
<p>  整洁数据（Tidy Data）是由<a href="https://posit.co/">Posit</a>公司（之前名称为Rstudio）的首席科学家Hadley Wickham提出的，初衷是为了简化数据清洗的流程，提高数据清洗效率。<span class="citation" data-cites="wickham2014">Wickham (<a href="references.html#ref-wickham2014" role="doc-biblioref">2014</a>)</span> 认为Tidy Data更易于操作、建模和可视化，并且应该具备三种特征：</p>
<ul>
<li>Each variable is a column, and that column contains one “type” of data.</li>
<li>Each observation is a row.</li>
<li>Each type of observational unit is a table.</li>
</ul>
<p>  打眼一看，你可能觉得上面三句话说的是废话，心里想着大家不是都是这么建数据库的吗？其实不然，比如可以看下面的例子。</p>
<p>  如 <a href="#tbl-sample-tidy-1">表&nbsp;<span>3.1</span></a> 是日常工作和研究中非常常见的建数据库方式，但是这样的方式对于统计分析来说并不友好。比如当你想要知道每一科考试得分的最大值最小值时，你通常需要对数学、语文、英语重复三次同样的操作。</p>
<div id="tbl-sample-tidy-1" class="anchored">
<table class="table">
<caption>表&nbsp;3.1: 常见数据结构示例一</caption>
<thead>
<tr class="header">
<th>姓名</th>
<th>数学</th>
<th>语文</th>
<th>英语</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>张三</td>
<td>80</td>
<td>90</td>
<td>95</td>
</tr>
<tr class="even">
<td>李四</td>
<td>88</td>
<td>95</td>
<td>97</td>
</tr>
</tbody>
</table>
</div>
<p>  再比如，当有多次考试的成绩需要记录时，很多人会选择 <a href="#tbl-sample-tidy-2">表&nbsp;<span>3.2</span></a> 这样的方式，但是这样的结构在数据分析时会更不友好。</p>
<div id="tbl-sample-tidy-2" class="anchored">
<table class="table">
<caption>表&nbsp;3.2: 常见数据结构示例二</caption>
<thead>
<tr class="header">
<th>姓名</th>
<th>第一次</th>
<th></th>
<th></th>
<th>第二次</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td></td>
<td>数学</td>
<td>语文</td>
<td>英语</td>
<td>数学</td>
<td>语文</td>
<td>英语</td>
</tr>
<tr class="even">
<td>张三</td>
<td>80</td>
<td>90</td>
<td>95</td>
<td>85</td>
<td>92</td>
<td>97</td>
</tr>
<tr class="odd">
<td>李四</td>
<td>88</td>
<td>95</td>
<td>97</td>
<td>87</td>
<td>90</td>
<td>98</td>
</tr>
</tbody>
</table>
</div>
<p>  符合Tidy Data要求的建立数据库方式应该如 <a href="#tbl-sample-tidy-3">表&nbsp;<span>3.3</span></a> 所示，在这种结构下，结合Group by等操作，会给数据分析带来很大的便利。</p>
<div id="tbl-sample-tidy-3" class="anchored">
<table class="table">
<caption>表&nbsp;3.3: 常见数据结构示例三</caption>
<thead>
<tr class="header">
<th>姓名</th>
<th>考试</th>
<th>学科</th>
<th>得分</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>张三</td>
<td>第一次模拟考</td>
<td>数学</td>
<td>80</td>
</tr>
<tr class="even">
<td>李四</td>
<td>第一次模拟考</td>
<td>数学</td>
<td>88</td>
</tr>
<tr class="odd">
<td>张三</td>
<td>第一次模拟考</td>
<td>语文</td>
<td>90</td>
</tr>
<tr class="even">
<td>李四</td>
<td>第一次模拟考</td>
<td>语文</td>
<td>95</td>
</tr>
<tr class="odd">
<td>张三</td>
<td>第一次模拟考</td>
<td>英语</td>
<td>95</td>
</tr>
<tr class="even">
<td>李四</td>
<td>第一次模拟考</td>
<td>英语</td>
<td>97</td>
</tr>
<tr class="odd">
<td>张三</td>
<td>第二次模拟考</td>
<td>数学</td>
<td>85</td>
</tr>
<tr class="even">
<td>李四</td>
<td>第二次模拟考</td>
<td>数学</td>
<td>87</td>
</tr>
<tr class="odd">
<td>张三</td>
<td>第二次模拟考</td>
<td>语文</td>
<td>92</td>
</tr>
<tr class="even">
<td>李四</td>
<td>第二次模拟考</td>
<td>语文</td>
<td>90</td>
</tr>
<tr class="odd">
<td>张三</td>
<td>第二次模拟考</td>
<td>英语</td>
<td>97</td>
</tr>
<tr class="even">
<td>李四</td>
<td>第二次模拟考</td>
<td>英语</td>
<td>98</td>
</tr>
</tbody>
</table>
</div>
<p>  关于Tidy Data的内容还有很多，具体可以详细参考 <span class="citation" data-cites="wickham2014">Wickham (<a href="references.html#ref-wickham2014" role="doc-biblioref">2014</a>)</span> 的文章，这里就不进行搬运工作了。在设计数据库的时候，只需要记住不要把数据<em>展示形式</em>当成数据库的<em>结构形式</em>就可以。</p>
</section>
</section>
<section id="数据清洗内容" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="数据清洗内容"><span class="header-section-number">3.3</span> 数据清洗内容</h2>
<p>  由于异常值处理、重复值处理、规范变量类型及取值、识别并处理结构错误的内容相对比较简单，在本节中将不会详细举例说明。以下就异常值及缺失值的处理流程予以详细说明。一般情况下，数据清洗可以按照 <a href="#fig-flow-clean">图&nbsp;<span>3.1</span></a> 所示流程进行。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-flow-clean" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p>
</p><pre class="mermaid" data-tooltip-selector="#mermaid-tooltip-1">flowchart LR
  A[概览] --&gt; B(异常值识别处理)
  B --&gt; C{缺失值识别与处理}
  C --&gt; D[重复值识别与处理]
  D --&gt; E[标准化变量和取值]
</pre>
<div id="mermaid-tooltip-1" class="mermaidTooltip">

</div>
<p></p>
<p></p><figcaption class="figure-caption">图&nbsp;3.1: 数据清洗流程图</figcaption><p></p>
</figure>
</div>
</div>
</div>
<section id="数据清洗的第一步" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="数据清洗的第一步"><span class="header-section-number">3.3.1</span> 数据清洗的第一步</h3>
<p>  数据清洗的第一步就是需要对数据库有一个整体的把握，如有多少个变量、多少条记录、变量类型如何、取值是什么等。在规范的研究项目（如注册的药物/器械临床试验）中，这些信息会记录在Codebook中随同数据一并交给统计师，通过翻阅Codebook就可以清楚地了解以上这些信息。这就是为何本书在 <a href="chapter_2.html#sec-codebook"><span>Section&nbsp;2.2.4</span></a> 中强调整理和制作Codebook的重要性。然而，很多时候，对于大部分的问卷调查数据而言，很少见到有研究者严格按照类似临床试验的要求建立和管理数据库的，以及对于从医院、互联网平台等处获取的数据而言，都不会事先提供这些信息，因此拿到数据库的第一步就是去了解这些信息。</p>
<p>  一般我将这一步称为数据库的概览（Overview），在R中通常使用<code>str()</code>函数或者<code>glimpse()</code>函数可以大致对数据结构有一个初步了解，更为推荐的工具和方法可参见 <a href="chapter_4.html#sec-descrip"><span>Section&nbsp;4.2.2</span></a> ，本节仅给出简单的示例，具体如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(mtcars)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">glimpse</span>(mtcars[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 5
Columns: 6
$ mpg  &lt;dbl&gt; 21.0, 21.0, 22.8, 21.4, 18.7
$ cyl  &lt;dbl&gt; 6, 6, 4, 6, 8
$ disp &lt;dbl&gt; 160, 160, 108, 258, 360
$ hp   &lt;dbl&gt; 110, 110, 93, 110, 175
$ drat &lt;dbl&gt; 3.90, 3.90, 3.85, 3.08, 3.15
$ wt   &lt;dbl&gt; 2.620, 2.875, 2.320, 3.215, 3.440</code></pre>
</div>
</div>
</section>
<section id="规范变量类型及取值" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="规范变量类型及取值"><span class="header-section-number">3.3.2</span> 规范变量类型及取值</h3>
<p>  严格来说，这一步工作属于数据库管理的内容范畴，不应该在数据清洗阶段。但是，考虑到现在的研究，很多时候拿到的就是非常自然和原始的数据，这些工作也需要在数据清洗的时候进行。规范变量类型和取值的具体含义是指，数值型变量在数据库中的类型应该为Int或者Float，如年龄或者收入等指标；字符变量在数据库应该为String，如家庭住址或者出院诊断等指标；日期就应该Date，时间就应该是Time；另有一类较为特殊的是分类变量，如性别或学历等，可以用0、1、2等数字编码后，以Int类型存储，亦可直接以String类型存储为“男”和“女”等，两种方法各有利弊，根据研究习惯选择即可。</p>
</section>
<section id="异常值outliers处理" class="level3" data-number="3.3.3">
<h3 data-number="3.3.3" class="anchored" data-anchor-id="异常值outliers处理"><span class="header-section-number">3.3.3</span> 异常值（Outliers）处理</h3>
<p>  异常值处理根据变量的类型不同采取的方法有所区别。对于数值型变量<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> 采用直方图（Histogram）、箱式图（Boxplot）或者小提琴图（Violin plot）可直观的了解异常值的分布情况；对于分类变量采用频数频率表或交叉表（Crosstable）可清晰地了解异常值情况。关于作图和作表方法可详见本书后续章节 。</p>
<p>  关于数值型变量异常值的判定标准，大致可以分为以下三种方法：</p>
<ul>
<li>分位数法：通过计算1%和99%处的分位数，并将其作为上下界，界限之外的即为异常值。</li>
<li>四分位数间距法：通过计算25%和75%的分位数，也就是四分位数Q1和Q3，以及其间距IQR，然后计算异常值的上下限分别为：Q1 - 1.5 x IQR和Q3 + 1.5 x IQR。</li>
<li>标准差法：将数据均值加减3~5个标准差，定义为上下界。</li>
</ul>
<p>  关于数值型变量异常值的处理，如果是问卷数据，通常需要首先核对原始数据，排除因录入错误导致的数据异常，若排除此种原因，可采取截尾方法，剔除异常值。</p>
</section>
</section>
<section id="缺失值missing-value处理" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="缺失值missing-value处理"><span class="header-section-number">3.4</span> 缺失值（Missing Value）处理</h2>
<p>  由于这部分内容较多，因此单独用一节来介绍，本部分主要参考 <span class="citation" data-cites="gao2013">van Buuren and Groothuis-Oudshoorn (<a href="references.html#ref-buuren2011" role="doc-biblioref">2011</a>)</span>。Missing Value的处理也是非常重要的一个环节，因此规范的缺失数据的处理直接影响着研究结果的稳健性和真实性，也是研究能够Reproductive的重要保障。通常，处理缺失值的步骤如下：</p>
<ul>
<li>识别缺失数据。</li>
<li>检查导致数据缺失的原因。</li>
<li>删除包含缺失值的实例或是合理的数值代替（插补）缺失值。</li>
</ul>
<section id="识别缺失数据" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="识别缺失数据"><span class="header-section-number">3.4.1</span> 识别缺失数据</h3>
<section id="缺失数据分类" class="level4" data-number="3.4.1.1">
<h4 data-number="3.4.1.1" class="anchored" data-anchor-id="缺失数据分类"><span class="header-section-number">3.4.1.1</span> 缺失数据分类</h4>
<p>  在识别缺失数据之前，先来了解一下缺失数据的分类，它直接关系到处理缺失值方式的选择。</p>
<ul>
<li><ol type="1">
<li>完全随机缺失。若某变量的缺失数据与其他任何观测或未观测变量都不相关，则数据为完全随机缺失（MCAR）。若12个动物的做梦时长值缺失不是由于系统原因，那么可认为数据是MCAR。注意，如果每个有缺失值的变量都是MCAR，那么可以将数据完整的实例看做是对更大数据集的一个简单随机抽样。</li>
</ol></li>
<li><ol start="2" type="1">
<li>随机缺失 若某变量上的缺失数据与其他观测变量相关，与它自己的未观测值不相关，则数据为随机缺失（MAR）。</li>
</ol></li>
<li><ol start="3" type="1">
<li>非随机缺失 若缺失数据不属于MCAR或MAR，则数据为非随机缺失（NMAR）。</li>
</ol></li>
</ul>
<p>  例如：</p>
<ul>
<li>（1）在最近一个问卷调查中，发现一些项常常一同缺失。很明显这些项聚集在一起，因为调查对象没有意识到问卷的第三页的背面也包含了这些项目。此时，可以认为这些数据是MCAR。<br>
</li>
<li>（2）在一个关于全球领导风格的调查中，学历变量经常性地缺失。调查显示欧洲的调查对象更可能在此项目上留白，这说明某些特定国家的调查对象没有理解变量的分类。此时，这种数据最可能是MAR。</li>
</ul>
<p>  大部分处理缺失数据的方法都假定数据是MCAR或MAR。此时，你可以忽略缺失数据的生成机制。当数据是NMAR时，想对它进行恰当地分析比较困难，既要对感兴趣的关系进行建模，还要对缺失值的生成机制进行建模。</p>
</section>
<section id="识别缺失值" class="level4" data-number="3.4.1.2">
<h4 data-number="3.4.1.2" class="anchored" data-anchor-id="识别缺失值"><span class="header-section-number">3.4.1.2</span> 识别缺失值</h4>
<p>  此次只用R来演示软件操作过程，Stata及SAS等其他软件可自行查阅相关文档。以下研究主要使用R的<strong>VIM</strong>包，以及该包中自带的sleep数据集进行演示。</p>
<p><strong>sleep数据集简介</strong></p>
<blockquote class="blockquote">
<p>睡眠变量包含睡眠中做梦时长（Dream）、不做梦的时长（NonD）以及它们的和（Sleep）。体质变量包含体重（BodyWgt，单位为千克）、脑重（BrainWgt，单位为克）、寿命（Span，单位为年）和妊娠期（Gest，单位为天）。生态学变量包含物种被捕食的程度（Pred）、睡眠时暴露的程度（Exp）和面临的总危险度（Danger）。</p>
</blockquote>
<p><strong>1) 以表格形式进行探索</strong></p>
<p>  主要使用的<code>is.na()</code>和<code>complete.cases()</code>函数。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载VIM包</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(VIM)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载数据集</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(sleep, <span class="at">package =</span> <span class="st">"VIM"</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 列出没有缺失值的行</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>sleep[<span class="fu">complete.cases</span>(sleep[, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]), <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    BodyWgt BrainWgt NonD Dream Sleep
2     1.000     6.60  6.3   2.0   8.3
5  2547.000  4603.00  2.1   1.8   3.9
6    10.550   179.50  9.1   0.7   9.8
7     0.023     0.30 15.8   3.9  19.7
8   160.000   169.00  5.2   1.0   6.2
9     3.300    25.60 10.9   3.6  14.5
10   52.160   440.00  8.3   1.4   9.7
11    0.425     6.40 11.0   1.5  12.5
12  465.000   423.00  3.2   0.7   3.9
13    0.550     2.40  7.6   2.7  10.3
15    0.075     1.20  6.3   2.1   8.4
16    3.000    25.00  8.6   0.0   8.6
17    0.785     3.50  6.6   4.1  10.7
18    0.200     5.00  9.5   1.2  10.7
19    1.410    17.50  4.8   1.3   6.1
20   60.000    81.00 12.0   6.1  18.1
22   27.660   115.00  3.3   0.5   3.8
23    0.120     1.00 11.0   3.4  14.4
25   85.000   325.00  4.7   1.5   6.2
27    0.101     4.00 10.4   3.4  13.8
28    1.040     5.50  7.4   0.8   8.2
29  521.000   655.00  2.1   0.8   2.9
32    0.005     0.14  7.7   1.4   9.1
33    0.010     0.25 17.9   2.0  19.9
34   62.000  1320.00  6.1   1.9   8.0
35    0.122     3.00  8.2   2.4  10.6
36    1.350     8.10  8.4   2.8  11.2
37    0.023     0.40 11.9   1.3  13.2
38    0.048     0.33 10.8   2.0  12.8
39    1.700     6.30 13.8   5.6  19.4
40    3.500    10.80 14.3   3.1  17.4
42    0.480    15.50 15.2   1.8  17.0
43   10.000   115.00 10.0   0.9  10.9
44    1.620    11.40 11.9   1.8  13.7
45  192.000   180.00  6.5   1.9   8.4
46    2.500    12.10  7.5   0.9   8.4
48    0.280     1.90 10.6   2.6  13.2
49    4.235    50.40  7.4   2.4   9.8
50    6.800   179.00  8.4   1.2   9.6
51    0.750    12.30  5.7   0.9   6.6
52    3.600    21.00  4.9   0.5   5.4
54   55.500   175.00  3.2   0.6   3.8
56    0.060     1.00  8.1   2.2  10.3
57    0.900     2.60 11.0   2.3  13.3
58    2.000    12.30  4.9   0.5   5.4
59    0.104     2.50 13.2   2.6  15.8
60    4.190    58.00  9.7   0.6  10.3
61    3.500     3.90 12.8   6.6  19.4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#列出有一个或多个缺失值的行</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>sleep[<span class="sc">!</span><span class="fu">complete.cases</span>(sleep[, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]), <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    BodyWgt BrainWgt NonD Dream Sleep
1  6654.000   5712.0   NA    NA   3.3
3     3.385     44.5   NA    NA  12.5
4     0.920      5.7   NA    NA  16.5
14  187.100    419.0   NA    NA   3.1
21  529.000    680.0   NA   0.3    NA
24  207.000    406.0   NA    NA  12.0
26   36.330    119.5   NA    NA  13.0
30  100.000    157.0   NA    NA  10.8
31   35.000     56.0   NA    NA    NA
41  250.000    490.0   NA   1.0    NA
47    4.288     39.2   NA    NA  12.5
53   14.830     98.2   NA    NA   2.6
55    1.400     12.5   NA    NA  11.0
62    4.050     17.0   NA    NA    NA</code></pre>
</div>
</div>
<p>  从结果可以看出，完整数据集中有62条observation，其中只有42条不含缺失值，20条含一个或多个缺失值。由于逻辑值TRUE和FALSE分别等价于数值1和0，可用sum()和mean()函数来获取关于缺失数据的有用信息。如：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(sleep<span class="sc">$</span>Dream))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 12</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">is.na</span>(sleep<span class="sc">$</span>Dream))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1935484</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="sc">!</span><span class="fu">complete.cases</span>(sleep))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3225806</code></pre>
</div>
</div>
<p>  结果表明变量Dream有12个缺失值，19%的实例在此变量上有缺失值。另外，数据集中32%的实例包含一个或多个缺失值。另外一种方法是，采用<strong>mice</strong>包中的<em>md.pattern()</em>函数来生成缺失值矩阵，如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mice)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">md.pattern</span>(sleep[, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>], <span class="at">plot =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   BodyWgt BrainWgt Sleep Dream NonD   
48       1        1     1     1    1  0
10       1        1     1     0    0  2
2        1        1     0     1    0  2
2        1        1     0     0    0  3
         0        0     4    12   14 30</code></pre>
</div>
</div>
<p>  结果中，最右侧列显示的是缺失的variable数量，0表示无缺失；最左侧列显示对应的observation数量，如第一行显示，有42条observation在BodyWgt等10个variable中均无缺失；第二行显示，Dream和NonD共2个变量同时有缺失的observation有9条。那么，数据集的20条缺失observation中，共包含缺失值(42 × 0) + (2 × 1) + … + (1 × 3) = 38个。</p>
<p><strong>2) 以图形探索缺失数据</strong></p>
<p>  虽然表格的输出也很简洁，但是图形的输出会更直观，此时可以采用VIM包中的<code>aggr()</code>和<code>matrixplot()</code>函数。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">aggr</span>(sleep, <span class="at">prop =</span> <span class="cn">FALSE</span>, </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">numbers =</span> <span class="cn">TRUE</span>, </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">labels =</span> <span class="cn">TRUE</span>, )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-miss-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="chapter_3_files/figure-html/fig-miss-1-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">图&nbsp;3.2: aggr()生成的sleep数据集的缺失值模式图形</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>  如 <a href="#fig-miss-1">图&nbsp;<span>3.2</span></a>，左侧的红色条图分别显示了所有variable的缺失值数量，可以清楚的看出Gest变量有4个缺失值等。右侧的图中，红色代表缺失，可以看出无任何缺失的observation共有42条，同时了缺失NonD和Dream的observation共有9条。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">matrixplot</span>(sleep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Click in a column to sort by the corresponding variable.
To regain use of the VIM GUI and the R console, click outside the plot region.</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-miss-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="chapter_3_files/figure-html/fig-miss-2-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">图&nbsp;3.3: 按实例（行）展示真实值和缺失值的矩阵图</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>  <code>matrixplot()</code>函数可生成展示每个实例数据的图形。此处，数值型数据被重新转换到[0, 1]区间，并用灰度来表示大小：浅色表示值小，深色表示值大。默认缺失值为红色。 <a href="#fig-miss-2">图&nbsp;<span>3.3</span></a>，横轴展示了全部的variable，纵轴显示了全部observation，从图中可以清楚的了解缺失值的分布情况，默认是按照第一个变量BodyWgt从小到大排序过。</p>
</section>
</section>
<section id="探索缺失原因或模式" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="探索缺失原因或模式"><span class="header-section-number">3.4.2</span> 探索缺失原因或模式</h3>
<section id="通过图形捕捉缺失原因或模式" class="level4" data-number="3.4.2.1">
<h4 data-number="3.4.2.1" class="anchored" data-anchor-id="通过图形捕捉缺失原因或模式"><span class="header-section-number">3.4.2.1</span> 通过图形捕捉缺失原因或模式</h4>
<p>  通过Fig.2的矩阵图中，可以看出某些变量的缺失值模式是否与其他变量的真实值有关联。此图中可以看到，无缺失值的睡眠变量（Dream、NonD和Sleep）对应着较小的体重（BodyWgt）或脑重（BrainWgt）。此时，可以采用VIM包中的<em>marginplot()</em>函数可生成一幅散点图，在图形边界展示两个变量的缺失值信息，并观察变量之间的关系。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">marginplot</span>(sleep[<span class="fu">c</span>(<span class="st">"Gest"</span>, <span class="st">"Dream"</span>)], </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"darkgrey"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span>), </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-miss-3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="chapter_3_files/figure-html/fig-miss-3-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">图&nbsp;3.4: 变量Gest与Deam的散点图及缺失信息</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>   <a href="#fig-miss-3">图&nbsp;<span>3.4</span></a>，共显示了两部分信息，（a）散点图（b）边界显示缺失信息，具体为：</p>
<ul>
<li>横轴为Gest变量，边界的红色boxplot显示的是Dream变量中缺失值对应的Gest值的箱式图，灰色为Dream变量中非缺失值对应的Gest值的箱式图。</li>
<li>纵轴为Dream变量，边界的红色boxplot显示的是Gest变量中缺失值对应的Dream值的箱式图，灰色为Gest变量中非缺失值对应的Dream值的箱式图。</li>
<li>灰色散点为Dream与Gest的散点图。</li>
<li>左下角的蓝色数字表示Dream与Gest共同缺失的observation数量。</li>
</ul>
<p>  从 <a href="#fig-miss-3">图&nbsp;<span>3.4</span></a> 可以看出，Dream与Gest成负相关关系，并且，Gest的缺失值对应更大的Dream值，即缺失妊娠期数据时动物的做梦时长一般更长。</p>
</section>
<section id="通过相关性探索缺失值" class="level4" data-number="3.4.2.2">
<h4 data-number="3.4.2.2" class="anchored" data-anchor-id="通过相关性探索缺失值"><span class="header-section-number">3.4.2.2</span> 通过相关性探索缺失值</h4>
<p>  图形展示了缺失变量之间可能的相关关系，进一步可用指示变量替代数据集中的数据（1表示缺失，0表示存在），这样生成的矩阵有时称作影子矩阵。求这些指示变量间和它们与初始（可观测）变量间的相关性，有助于观察哪些变量常一起缺失，以及分析变量“缺失”与其他变量间的关系。具体如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 管道函数包</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 将是否缺失的逻辑变量转换为0和1变量的数据框形式</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">is.na</span>(sleep[, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])) <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">as.data.frame</span>()</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">apply</span>(a, <span class="dv">2</span>, sum) <span class="sc">%&gt;%</span> </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>       .[<span class="fu">which</span>(. <span class="sc">!=</span> <span class="dv">0</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>       <span class="fu">names</span>()</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 提取出缺失数据</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>c <span class="ot">&lt;-</span> <span class="fu">subset</span>(a, <span class="at">select =</span> b)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 对缺失数据进行相关分析</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(c, <span class="at">y =</span> <span class="cn">NULL</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           NonD     Dream     Sleep
NonD  1.0000000 0.9071147 0.4862645
Dream 0.9071147 1.0000000 0.2037014
Sleep 0.4862645 0.2037014 1.0000000</code></pre>
</div>
</div>
<p>  此时，你可以看到Dream和NonD常常一起缺失（r = 0.91）。相对可能性较小的是Sleep和NonD一起缺失（r = 0.49），以及Sleep和Dream（r = 0.20）</p>
</section>
</section>
<section id="缺失值的处理" class="level3" data-number="3.4.3">
<h3 data-number="3.4.3" class="anchored" data-anchor-id="缺失值的处理"><span class="header-section-number">3.4.3</span> 缺失值的处理</h3>
<p>  在对缺失数据进行识别和探索后，下一步就是对缺失数据进行填补，但是在进行下一步之前，需要前面的工作弄清楚几个问题，以便选择合理的缺失值处理方式：</p>
<ul>
<li>缺失数据的比例为多少。</li>
<li>哪些变量上存在缺失，是否存在某种明显的分布趋势。</li>
<li>缺失的类型，完全随机（MCAR）、随机(MAR)或非随机(NMAR)。</li>
</ul>
<section id="缺失值处理方式" class="level4" data-number="3.4.3.1">
<h4 data-number="3.4.3.1" class="anchored" data-anchor-id="缺失值处理方式"><span class="header-section-number">3.4.3.1</span> 缺失值处理方式</h4>
<p>  缺失值的处理通常有以下4种方法，其中前三种处理方式比较常用。除非特别必要，一般情况下较少会选择填补法。<em>另外需要强调的是，若采取删除缺失值的处理方式，通常需要对删除缺失前的数据库和删除后的数据库进行比较，主要采用描述性统计方法检验关键的人口学特征是否存在差异。若不存在差异方可说明采用删除缺失值的方式是可取的，否则就会改变样本的代表性。</em></p>
<ol type="1">
<li><p>不予处理：如果有一小部分数据（如小于10%）随机分布在整个数据集中（MCAR），那么你可以分析数据完整的实例，这样仍可以得到可靠且有效的结果。</p></li>
<li><p>删除变量（列）：如果缺失数据集中在几个相对不太重要的变量上，那么你可以删除这些变量，然后再进行正常的数据分析.</p></li>
<li><p>删除观测（行）：在完整的数据分析中，只有每个变量都包含了有效数据值的观测才会保留下来做进一步的分析。实际上，这样会导致包含一个或多个缺失值的任意一行都会被删除，因此常称作行删除法（listwise）、个案删除（case-wise）或剔除。大部分流行的统计软件包都默认采用行删除法来处理缺失值。如果你平时留心观察过，不管是在Stata或者SAS中，进行crostable、t-test、anova或者regression分析的时候，默认都是剔除了包含缺失值的记录的。 但是，行删除法是有一个前提假定的，即数据是完全随机缺失（MCAR）（即完整的观测只是全数据集的一个随机子样本）。如果不满足此条件，那么删除行是会产生有偏的结果。</p></li>
<li><p>数据填补：根据研究设计不同，填补的方法有多种，如clinical trial中对于重复观察结果采用的末次观测结转(LOCF:Last observation carried forward)，以及平时常用的简单插补法（即用某个值（如均值、中位数或众数）来替换变量中的缺失值）。这里只介绍在面对复杂的缺失值问题时，常用的多重插补法(MI,Multiple imputation)，此处使用前面提到的R语言的<strong>mise</strong>包，其他软件也有类似的函数或者包。</p></li>
</ol>
</section>
<section id="多重插补法mimultiple-imputation" class="level4" data-number="3.4.3.2">
<h4 data-number="3.4.3.2" class="anchored" data-anchor-id="多重插补法mimultiple-imputation"><span class="header-section-number">3.4.3.2</span> 多重插补法(MI,Multiple imputation)</h4>
<p><strong>原理：</strong></p>
<p>  MI是将从一个包含缺失值的数据集中生成一组完整的数据集（通常是3到10个）。每个模拟数据集中，缺失数据将用蒙特卡洛方法来填补。缺失值的插补通过Gibbs抽样完成。每个包含缺失值的变量都默认可通过数据集中的其他变量预测得来，于是这些预测方程便可用来预测缺失数据的有效值。该过程不断迭代直到所有的缺失值都收敛为止。对于每个变量，用户可以选择预测模型的形式（称为基本插补法）和待选入的变量。默认地，预测的均值用来替换连续型变量中的缺失数据，而Logistic或多元Logistic回归则分别用来替换二值目标变量（两水平因子）或多值变量（多于两水平的因子）。其他基本插补法包括贝叶斯线性回归、判别分析、两水平正态插补和从观测值中随机抽样。用户也可以选择自己独有的方法。</p>
<p><strong>语法：</strong></p>
<p>  函数<code>mice()</code>首先从一个包含缺失数据的数据框开始，然后返回一个包含多个（默认为5个）完整数据集的对象。每个完整数据集都是通过对原始数据框中的缺失数据进行插补而生成的。由于插补有随机的成分，因此每个完整数据集都略有不同。然后，<code>with()</code>函数可依次对每个完整数据集应用统计模型（如线性模型或广义线性模型），最后，<code>pool()</code>函数将这些单独的分析结果整合为一组结果。</p>
<ul>
<li>m为生成的数据集个数，默认为5个, seed是设定种子数，保证填补结果的可重复性，值可任意设定。</li>
<li>导出需要的填补完整数据集，action表示选择哪一个。</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mice) </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>imp <span class="ot">&lt;-</span> <span class="fu">mice</span>(df, m, </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">seed =</span> <span class="dv">1234</span>, <span class="at">method =</span> <span class="st">"pmm"</span>) </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>sleep_im <span class="ot">&lt;-</span> <span class="fu">complete</span>(pooled, <span class="at">action =</span> <span class="dv">3</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>  method为默认插补方式，pmm为默认方式预测均值匹配（Predictive mean matching）, 还有一些其他methods插补方法:</p>
<ul>
<li>贝叶斯线性回归（norm）。</li>
<li>基于bootstrap的线性回归（norm.boot）。</li>
<li>线性回归预测值（norm.predict）。</li>
<li>分类回归树（cart）。</li>
<li>随机森林（rf）。</li>
</ul>
<p>  使用这些插补方法对数据有严格的要求，比如贝叶斯线性回归等前三个模型都需要数据符合numeric格式，而pmm、cart、rf任意格式都行。</p>
<p><strong>使用以上模型遇见的问题有：</strong></p>
<ol type="1">
<li><p>pmm相当于某一指标的平均值作为插补，会出现插补值重复的问题。</p></li>
<li><p>cart以及rf是挑选某指标中最大分类的那个数字，是指标中的某一个数字，未按照规律。</p></li>
<li><p>要使用norm.predict，必须先对数据进行格式转换，这个过程中会出现一些错误。</p></li>
</ol>
<p><strong>实例：</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>imp <span class="ot">&lt;-</span> <span class="fu">mice</span>(sleep, <span class="at">seed =</span> <span class="dv">1234</span>, <span class="at">method =</span> <span class="st">"pmm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 iter imp variable
  1   1  NonD  Dream  Sleep  Span  Gest
  1   2  NonD  Dream  Sleep  Span  Gest
  1   3  NonD  Dream  Sleep  Span  Gest
  1   4  NonD  Dream  Sleep  Span  Gest
  1   5  NonD  Dream  Sleep  Span  Gest
  2   1  NonD  Dream  Sleep  Span  Gest
  2   2  NonD  Dream  Sleep  Span  Gest
  2   3  NonD  Dream  Sleep  Span  Gest
  2   4  NonD  Dream  Sleep  Span  Gest
  2   5  NonD  Dream  Sleep  Span  Gest
  3   1  NonD  Dream  Sleep  Span  Gest
  3   2  NonD  Dream  Sleep  Span  Gest
  3   3  NonD  Dream  Sleep  Span  Gest
  3   4  NonD  Dream  Sleep  Span  Gest
  3   5  NonD  Dream  Sleep  Span  Gest
  4   1  NonD  Dream  Sleep  Span  Gest
  4   2  NonD  Dream  Sleep  Span  Gest
  4   3  NonD  Dream  Sleep  Span  Gest
  4   4  NonD  Dream  Sleep  Span  Gest
  4   5  NonD  Dream  Sleep  Span  Gest
  5   1  NonD  Dream  Sleep  Span  Gest
  5   2  NonD  Dream  Sleep  Span  Gest
  5   3  NonD  Dream  Sleep  Span  Gest
  5   4  NonD  Dream  Sleep  Span  Gest
  5   5  NonD  Dream  Sleep  Span  Gest</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Number of logged events: 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>sleep_im <span class="ot">&lt;-</span> <span class="fu">complete</span>(imp, <span class="at">action =</span> <span class="dv">1</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">#查看填补情况</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>imp<span class="sc">$</span>imp<span class="sc">$</span>Dream</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     1   2   3   4   5
1  0.0 0.5 0.5 0.5 0.3
3  0.5 1.4 1.5 1.5 1.3
4  3.6 4.1 3.1 4.1 2.7
14 0.3 1.0 0.5 0.0 0.0
24 3.6 0.8 1.4 1.4 0.9
26 2.4 0.5 3.9 3.4 1.2
30 2.6 0.8 2.4 2.2 3.1
31 0.6 1.3 1.2 1.8 2.1
47 1.3 1.8 1.8 1.8 3.9
53 0.5 0.5 0.6 0.5 0.3
55 2.6 3.6 2.4 1.8 0.5
62 1.5 3.4 3.9 3.4 2.2</code></pre>
</div>
</div>
<p><strong>检查插补效果：</strong></p>
<p>  通过散点图和分布图，检查填补数据的效果，<a href="#fig-miss-4">图&nbsp;<span>3.5</span></a> ，红色点表示填补值，蓝色表示非填补值。</p>
<div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lattice)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">xyplot</span>(imp, Dream <span class="sc">~</span> Gest <span class="sc">+</span> Span, </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="dv">18</span>, <span class="at">cex =</span> <span class="dv">1</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">densityplot</span>(imp)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">stripplot</span>(imp, <span class="at">pch =</span> <span class="dv">20</span>, <span class="at">cex =</span> <span class="fl">1.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-miss-4" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-miss-4-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="chapter_3_files/figure-html/fig-miss-4-1.png" class="img-fluid figure-img" data-ref-parent="fig-miss-4" width="672"></p>
<p></p><figcaption class="figure-caption">(a) 散点图</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-miss-4-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="chapter_3_files/figure-html/fig-miss-4-2.png" class="img-fluid figure-img" data-ref-parent="fig-miss-4" width="672"></p>
<p></p><figcaption class="figure-caption">(b) 密度图</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-miss-4-3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="chapter_3_files/figure-html/fig-miss-4-3.png" class="img-fluid figure-img" data-ref-parent="fig-miss-4" width="672"></p>
<p></p><figcaption class="figure-caption">(c) 分布图</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">图&nbsp;3.5: Charts</figcaption><p></p>
</figure>
</div>
</div>
<p><strong>填补后数据集应用：</strong></p>
<p>  通常情况下，填补完成后，通常会进行回归分析，如前所示，MI填补生成了5个填补数据集，此时就会有一个疑问，到底选择哪一个作为最后的完整数据集。<strong>mice</strong>包提供了一个函数可以很容易的将5个填补数据集分别进行回归，然后将结果合并后返回一个结果。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>sleep_im_fit <span class="ot">&lt;-</span> <span class="fu">with</span>(imp, </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">lm</span>(Sleep <span class="sc">~</span> Gest <span class="sc">+</span> Span))</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>modelsummary<span class="sc">::</span><span class="fu">modelsummary</span>(sleep_im_fit,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">stars =</span> <span class="cn">TRUE</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">output =</span> <span class="st">"kableExtra"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table style="NAborder-bottom: 0; width: auto !important; margin-left: auto; margin-right: auto;" class="table">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> Model 1 </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> (Intercept) </td>
   <td style="text-align:center;"> 13.174*** </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.732) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Gest </td>
   <td style="text-align:center;"> −0.016*** </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.005) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Span </td>
   <td style="text-align:center;"> −0.020 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.035) </td>
  </tr>
</tbody>
<tfoot><tr><td style="padding: 0; " colspan="100%">
<sup></sup> + p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001</td></tr></tfoot>
</table>

</div>
</div>
<p>  处理一般线性回归的<code>lm()</code>函数，其他方法包括广义线性模型<code>glm()</code>函数、广义可加模型<code>gam()</code>，负二项模型<code>nbrm()</code>函数均可实现。</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-kabacoff2013" class="csl-entry" role="doc-biblioentry">
Kabacoff, Robert. 2013. <em>R in Action, Data Analysis and Graphics with r</em>. Manning.
</div>
<div id="ref-cody2008" class="csl-entry" role="doc-biblioentry">
Ron, Cody. 2008. <em>Cody’s Data Cleaning Techniques Using SAS</em>. Cary, NC: SAS Institute Inc.
</div>
<div id="ref-buuren2011" class="csl-entry" role="doc-biblioentry">
van Buuren, Stef, and Karin Groothuis-Oudshoorn. 2011. <span>“<span class="nocase">mice</span>: Multivariate Imputation by Chained Equations in r.”</span> <em>Journal of Statistical Software</em> 45 (3): 1–67. <a href="https://doi.org/10.18637/jss.v045.i03">https://doi.org/10.18637/jss.v045.i03</a>.
</div>
<div id="ref-wickham2014" class="csl-entry" role="doc-biblioentry">
Wickham, Hadley. 2014. <span>“Tidy Data.”</span> <em>Journal of Statistical Software</em> 59 (10): 1–23. <a href="https://doi.org/10.18637/jss.v059.i10">https://doi.org/10.18637/jss.v059.i10</a>.
</div>
<div id="ref-gao2013" class="csl-entry" role="doc-biblioentry">
高涛, 肖楠, and 陈钢. 2013. <em>R语言实战</em>. 人民邮电出版社.
</div>
</div>
</section>
</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>本书中所讲的数值型变量是指根据统计学中的标准划分的计量和计数指标，而非指数据库中存储为Int或者Float类型的变量。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./chapter_2.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">数据库操作</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./chapter_4.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">数据的描述</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">
        <ul class="footer-items list-unstyled">
    <li class="nav-item">
 © 2022 Chi Shen, Xi'an Jiaotong University
  </li>  
</ul>
      </div>
  </div>
</footer>



</body></html>